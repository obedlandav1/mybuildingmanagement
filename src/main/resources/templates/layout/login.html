<!DOCTYPE html>
<html lang="en" class="light-style customizer-hide" dir="ltr" data-theme="theme-default" data-assets-path=""
    data-template="vertical-menu-template-free">

<head th:replace="~{fragments/head :: head('Login')}"></head>

<body>
    <!-- Content -->
    <div class="container-xxl" id="app" v-clock>
        <div class="authentication-wrapper authentication-basic container-p-y">
            <div class="authentication-inner">
                <!-- Register -->
                <div class="card">
                    <div class="card-body">
                        <h4 class="mb-6">Bienvenido a Mybuildingmanagement!</h4>
                        <form id="formAuthentication" class="mb-3" action="index.html" method="POST">
                            <div class="mb-3">
                                <label for="email" class="form-label">N&#250;mero de DNI:</label>
                                <input type="text" class="form-control" id="usuario" v-model="usuario"
                                    placeholder="Ingrese su DNI" autofocus required />
                            </div>
                            <div class="mb-3 form-password-toggle">
                                <label for="email" class="form-label">Contrase&#241;a</label>
                                <div class="input-group input-group-merge">
                                    <input type="password" id="password" v-model="password" class="form-control"
                                        name="password" placeholder="Ingrese su contrase&#241;a"
                                        aria-describedby="password" required />
                                    <span class="input-group-text cursor-pointer"><i class="bx bx-hide"></i></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button @click="login" type="button" class="btn btn-primary d-grid w-100"
                                    data-bs-dismiss="modal">Acceder</button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- /Register -->
            </div>
            <!-- / Content -->
        </div>

        <!-- Toggle Between Modals -->
        <div class="col-lg-4 col-md-6">
            <div class="mt-3">
                <div class="modal fade" id="modalToggle" aria-labelledby="modalToggleLabel" tabindex="-1"
                    style="display: none" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalToggleLabel">{{ modalTitulo }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p :class="modalClase">{{ modalMensaje }}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- / Toggle Between Modals -->
        </div>

        <div th:replace="~{fragments/scripts :: scripts}"></div>

        <script>
            new Vue({
                el: '#app',
                data: {
                    usuario: '',
                    password: '',
                    modalTitulo: '',
                    modalMensaje: '',
                    modalTipo: ''
                },
                methods: {
                    mostrarModal(titulo, mensaje, tipo) {
                        this.modalTitulo = titulo;
                        this.modalMensaje = mensaje;
                        this.modalClase = tipo;
                        $("#modalToggle").modal("show");
                    },
                    limpiar() {
                        this.usuario = '';
                        this.password = '';
                        this.modalTitulo = '';
                        this.modalMensaje = '';
                        this.modalClase = '';
                    },
                    login: function () {
                        if (!this.usuario || !this.password) {
                            this.mostrarModal('Advertencia', 'Uno o mas campos necesarios estan en blanco, debe verificar.', 'text-warning');
                            return;
                        }
                        const params = {
                            user: this.usuario,
                            pass: this.password
                        };
                        this.$http.post('api/usuario/validar', params, { emulateJSON: true })
                            .then(response => {
                                switch (response.status) {
                                    case 200:
                                        const user = response.body;
                                        const rol = user.rol;
                                        console.log(user);
                                        console.log(`api/session/usuario?idusuario=${user.idusuario}&nomusuario=${user.nomusuario}&rolusuario=${user.rol}&idcliente=${user.idcliente}&nomcliente=${user.nomcliente}`);
                                        this.$http.post(`api/session/usuario?idusuario=${user.idusuario}&nomusuario=${user.nomusuario}&rolusuario=${user.rol}&idcliente=${user.idcliente}&nomcliente=${user.nomcliente}`)
                                            .then(response => {
                                                this.mostrarModal('Bienvenido', 'Inicio de sesión exitoso. Redirigiendo...', 'text-success');
                                                setTimeout(() => {
                                                    $("#modalToggle").modal("hide");
                                                    switch (rol) {
                                                        case 1:
                                                            window.location.href = '/administrator';
                                                            break;
                                                        case 2:
                                                            window.location.href = '/manager';
                                                            break;
                                                        case 3:
                                                            window.location.href = '/automanagement';
                                                            break;
                                                        case 4:
                                                            window.location.href = '/owner';
                                                            break;
                                                        case 5:
                                                            window.location.href = '/janitor';
                                                            break;
                                                        default:
                                                            break;
                                                    }
                                                }, 1500)
                                            });
                                        ;
                                        break;
                                    case 401:
                                        this.mostrarModal('Error', 'Contraseña incorrecta. Intente nuevamente.', 'text-danger');
                                        break;
                                    case 404:
                                        this.mostrarModal('Usuario no encontrado', 'No existe un usuario con el DNI ingresado.', 'text-warning');
                                        break;
                                    default:
                                        this.mostrarModal('Error inesperado', 'Ha ocurrido un problema en el servidor.', 'text-muted');
                                        break;
                                }
                            }).catch(error => {
                                console.error(error);
                                this.mostrarModal('Error de conexión', 'No se pudo contactar con el servidor.', 'text-danger');
                            });
                    }
                },
                mounted() {
                    $('#modalToggle').on('hidden.bs.modal', () => {
                        this.clean();
                    });
                }
            });
        </script>
    </div>
</body>

</html>