<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path=""
    data-template="vertical-menu-template-free">

<head th:replace="~{fragments/head :: head('Edificios')}"></head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">

            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar :: administrator}"></div>
            <!-- / Sidebar -->

            <!-- Layout container -->
            <div class="layout-page">
                <!-- Navbar -->
                <div th:replace="~{fragments/navbar :: navbar}"></div>
                <!-- / Navbar -->

                <!-- Content wrapper -->
                <div class="content-wrapper">

                    <!-- Content -->
                    <div class="container-xxl flex-grow-1 container-p-y" id="app" v-cloak>
                        <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                            <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Registro /</span> Usuarios
                            </h4>

                            <div class="d-flex align-items-center">
                                <!--<label for="clienteSelect" class="form-label fw-bold m-0">Seleccione un cliente</label>-->
                                <span class="text-muted fw-light">Seleccione un cliente</span>
                                <select v-model="clienteid" @change="cargarUsuarios"
                                    class="form-control form-select w-20 ms-2 me-2" id="clienteSelect" required>
                                    <option disabled value="">-- Seleccione un cliente --</option>
                                    <option v-for="cliente in clientes" :key="cliente.idcliente"
                                        :value="cliente.idcliente">
                                        {{ cliente.razon_cliente }}
                                    </option>
                                </select>
                                <a th:href="@{/building-create}">
                                    <button type="button" class="btn btn-primary">Crear</button>
                                </a>
                            </div>

                        </div>
                        <!-- Basic Bootstrap Table -->
                        <div class="card">
                            <h5 class="card-header">Registro</h5>
                            <div class="table-responsive text-nowrap">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Apellido</th>
                                            <th>DNI</th>
                                            <th>Rol</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-border-bottom-0">
                                        <tr v-for="u in usuarios" :key="u.idusuario">
                                            <td><strong>{{ u.nombre_usuario }}</strong></td>
                                            <td>{{ u.apellido_usuario }}</td>
                                            <td>{{ u.dniusuario }}</td>
                                            <td>
                                                <span class="badge me-1" :class="getRolInfo(u.rol_usuario).clase">
                                                    {{ getRolInfo(u.rol_usuario).texto }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="dropdown dropstart">
                                                    <button type="button" class="btn p-0 dropdown-toggle hide-arrow"
                                                        data-bs-toggle="dropdown">
                                                        <i class="bx bx-dots-vertical-rounded"></i>
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        <a :href="'/administrator/pass-edit/' + u.idusuario"
                                                            class="dropdown-item">
                                                            <i class="bx bx-key me-1"></i> Act. password
                                                        </a>
                                                        <a :href="'/administrator/user-edit/' + u.idusuario"
                                                            class="dropdown-item">
                                                            <i class="bx bx-edit-alt me-1"></i> Editar
                                                        </a>
                                                        <a href="javascript:void(0);" class="dropdown-item"
                                                            @click="prepararEliminar(u.idusuario)">
                                                            <i class="bx bx-trash me-1"></i> Eliminar
                                                        </a>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!--/ Basic Bootstrap Table -->

                        <!-- Cargando -->
                        <div v-if="cargando" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Cargando usuarios...</p>
                        </div>
                        <!-- No hay cliente seleccionado -->
                        <div v-if="!cargando && !clienteid" class="alert alert-info w-100 mt-2" role="alert">
                            Debe seleccionar un cliente para mostrar los usuarios.
                        </div>
                        <!-- No hay datos -->
                        <div v-else-if="!cargando && usuarios.length === 0" class="alert alert-danger w-100 mt-2"
                            role="alert">
                            No existen datos que mostrar
                        </div>

                        <!-- Toggle Between Modals -->
                        <div class="col-lg-4 col-md-6">
                            <div class="mt-3">
                                <!-- Modal 1-->
                                <div class="modal fade" id="modalToggle" aria-labelledby="modalToggleLabel"
                                    tabindex="-1" style="display: none" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="modalToggleLabel">Eliminar Edificio</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">¿Desea eliminar el edificio? Esta acción no se puede
                                                deshacer</div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-outline-secondary"
                                                    data-bs-dismiss="modal">Cancelar</button>
                                                <button type="button" @click="confirmarEliminar"
                                                    class="btn btn-primary">Eliminar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- / Toggle Between Modals -->

                    </div>
                    <!-- / Content -->

                    <!-- Footer -->
                    <div th:replace="~{fragments/footer :: footer}"></div>
                    <!-- / Footer -->

                    <div class="content-backdrop fade"></div>
                </div>
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <div th:replace="~{fragments/scripts :: scripts}"></div>
    <div th:replace="~{fragments/vue-global-scripts :: none}"></div>

    <script>
        new Vue({
            el: "#app",
            data: {
                clientes: [],
                usuarios: [],
                cargando: false,
                error: '',
                clienteid: '',
                idusuario: ''
            },
            methods: {
                cargarClientes() {
                    this.$http.get('/api/cliente').then(response => {
                        this.clientes = response.data;
                    });
                },
                cargarUsuarios: function () {
                    if (this.clienteid) {
                        console.log(this.clienteid);
                        this.cargando = true;
                        this.$http.get(`/api/usuario/cliente/${this.clienteid}`)
                            .then(response => {
                                this.usuarios = response.data;
                                this.cargando = false;
                            }).catch(error => {
                                console.error(error);
                                this.error = "Error al cargar los usuarios.";
                                this.cargando = false;
                            });
                    } else {
                        this.usuarios = []; // Si no hay cliente, vacía la tabla
                    }
                },
                prepararEliminar: function (id) {
                    this.idusuario = id;
                    $("#modalToggle").modal("show");
                },
                confirmarEliminar: function () {
                    this.$http.delete(`/api/usuario/${this.idusuario}`)
                        .then(() => {
                            this.listar();
                            $("#modalToggle").modal("hide");
                        })
                        .catch(err => {
                            console.error(err);
                            alert("Error al eliminar el edificio.");
                        });
                }
            },
            mounted: function () {
                this.cargarClientes();
            }
        });
    </script>

</body>

</html>