<!DOCTYPE html>
<html lang="es" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default"
    data-template="vertical-menu-template-free">

<head th:replace="~{fragments/head :: head('Registrar Inmueble')}"></head>

<body>
    <div class="layout-wrapper layout-content-navbar" id="app" v-cloak>
        <div class="layout-container">

            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar :: sidebar}"></div>

            <!-- Layout -->
            <div class="layout-page">
                <div th:replace="~{fragments/navbar :: navbar}"></div>

                <div class="content-wrapper">
                    <div class="container-xxl flex-grow-1 container-p-y">
                        <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                            <h4 class="fw-bold py-0 mb-0">
                                <span class="text-muted fw-light">Registrar /</span> Inmueble
                            </h4>
                            <a th:href="@{/estate}">
                                <button type="button" class="btn btn-primary">Regresar</button>
                            </a>
                        </div>

                        <div class="col-xxl">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <form v-on:submit.prevent="guardarInmueble">
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Número de Inmueble</label>
                                            <div class="col-sm-10">
                                                <input v-model="inmueble.numero" type="text" class="form-control"
                                                    required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Tipo de Inmueble</label>
                                            <div class="col-sm-10">
                                                <input v-model="inmueble.tipo" type="text" class="form-control"
                                                    required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Metros cuadrados</label>
                                            <div class="col-sm-10">
                                                <input v-model="inmueble.metrosCuadrados" type="number"
                                                    class="form-control" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">% Participación</label>
                                            <div class="col-sm-10">
                                                <input v-model="inmueble.participacion" type="number" step="0.01"
                                                    class="form-control" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Estado</label>
                                            <div class="col-sm-10">
                                                <input v-model="inmueble.estado" type="text" class="form-control"
                                                    placeholder="Activo / Inactivo" required>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Edificio</label>
                                            <div class="col-sm-10">
                                                <select v-model="idEdificioSeleccionado" class="form-select">
                                                    <option value="">-- Seleccione --</option>
                                                    <option v-for="ed in edificios" :key="ed.idedificio"
                                                        :value="ed.idedificio">
                                                        {{ ed.nombre_edificio }}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                </div>

                                <div class="row mb-3">
                                    <label class="col-sm-2 col-form-label">Propietario</label>
                                    <div class="col-sm-10">
                                        <select v-model="inmueble.propietarios_idpropietario" class="form-control"
                                            required>
                                            <option v-for="propietario in propietarios" :value="propietario.id">
                                                {{ propietario.nombre }}</option>
                                        </select>
                                    </div>
                                </div>


                                <div class="row justify-content-end">
                                    <div class="col-sm-10">
                                        <button type="submit" class="btn btn-success">Guardar</button>
                                    </div>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div th:replace="~{fragments/footer :: footer}"></div>
                </div>
            </div>

           
        </div>
    </div>

    <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Core JS -->
    <script th:src="@{/vendor/libs/jquery/jquery.js}"></script>
    <script th:src="@{/vendor/js/bootstrap.js}"></script>
    <script th:src="@{/vendor/js/menu.js}"></script>
    <script th:src="@{/js/main-app.js}"></script>

    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>

    <!-- Vue Script -->
    <script>
        new Vue({
            el: '#app',
            data: {
                inmueble: {
                    numero: '',
                    tipo: '',
                    metrosCuadrados: '',
                    participacion: '',
                    estado: '',
                    edificios_idedificio: null,
                    propietarios_idpropietario: null
                },
                edificios: [],      // lista que llenas con un GET a /api/edificios
                propietarios: []    // lista que llenas con un GET a /api/propietarios
            },
            mounted() {
                this.obtenerEdificios();
            },
            methods: {
                obtenerEdificios() {
                    this.$http.get('/api').then(res => {
                        this.edificios = res.body;  // llena la lista de edificios
                    }).catch(err => {
                        console.error('Error al cargar edificios', err);
                    });
                },
                guardarInmueble() {
                    // agrega el id del edificio al payload
                    let payload = {
                        numero_inm: this.inmueble.numero,
                        tipo_inmueble: this.inmueble.tipo,
                        metro_cuadrado: this.inmueble.metrosCuadrados,
                        porcentaje_inm: this.inmueble.participacion,
                        estado_inm: this.inmueble.estado,
                        edificios_idedificio: this.idEdificioSeleccionado
                    };

                    this.$http.post('/api/inmuebles', payload).then(res => {
                        alert('Inmueble registrado correctamente');
                        window.location.href = '/estate';
                    }).catch(err => {
                        console.error(err);
                        alert('No se pudo registrar el inmueble');
                    });
                }
            }
        });
    </script>
</body>

</html>