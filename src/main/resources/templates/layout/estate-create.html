<!DOCTYPE html>
<html lang="es" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default">

<head th:replace="~{fragments/head :: head('Registrar Inmueble')}"></head>

<body>
    <div class="layout-wrapper layout-content-navbar" id="app" v-cloak>
        <div class="layout-container">

            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar :: sidebar}"></div>

            <div class="layout-page">
                <div th:replace="~{fragments/navbar :: navbar}"></div>

                <div class="content-wrapper">
                    <div class="container-xxl flex-grow-1 container-p-y">

                        <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                            <h4 class="fw-bold py-0 mb-0">
                                <span class="text-muted fw-light">Registrar /</span> Inmueble
                            </h4>
                            <a th:href="@{/estate}">
                                <button type="button" class="btn btn-primary">Regresar</button>
                            </a>
                        </div>

                        <div class="col-xxl">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <form @submit.prevent="guardarInmueble">

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Número Inmueble</label>
                                            <div class="col-sm-10">
                                                <input type="number" class="form-control" v-model="inmueble.numero_inm"
                                                    required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Tipo</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" v-model="inmueble.tipo_inmueble"
                                                    required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Metros cuadrados</label>
                                            <div class="col-sm-10">
                                                <input type="number" class="form-control"
                                                    v-model="inmueble.metro_cuadrado" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">% Participación</label>
                                            <div class="col-sm-10">
                                                <input type="number" step="0.01" class="form-control"
                                                    v-model="inmueble.porcentaje_inm" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Estado</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" v-model="inmueble.estado_inm"
                                                    readonly>
                                            </div>
                                        </div>

                                        <!-- Seleccionar Edificio -->
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Edificio</label>
                                            <div class="col-sm-10">
                                                <select v-model="idEdificioSeleccionado" class="form-select" required>
                                                    <option value="">-- Seleccione un edificio --</option>
                                                    <option v-for="ed in edificios" :key="ed.idedificio"
                                                        :value="ed.idedificio">
                                                        {{ ed.nombre_edificio }}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Seleccionar Propietario -->
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label">Propietario</label>
                                            <div class="col-sm-10">
                                                <select v-model="inmueble.propietarios_idpropietario"
                                                    class="form-select" required>
                                                    <option value="">-- Seleccione un propietario --</option>
                                                    <option v-for="p in propietarios" :key="p.idpropietario"
                                                        :value="p.idpropietario">
                                                        {{ p.nombre_pro }} {{ p.apellido_pro }}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Botón Guardar -->
                                        <div class="row justify-content-end">
                                            <div class="col-sm-10">
                                                <button type="submit" class="btn btn-success">Guardar</button>
                                            </div>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div th:replace="~{fragments/footer :: footer}"></div>
            </div>
        </div>

        <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Core JS -->
    <script th:src="@{/vendor/libs/jquery/jquery.js}"></script>
    <script th:src="@{/vendor/js/bootstrap.js}"></script>
    <script th:src="@{/vendor/js/menu.js}"></script>
    <script th:src="@{/js/main-app.js}"></script>

    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>

    <script>
        new Vue({
            el: "#app",
            data: {
                inmueble: {
                    numero_inm: "",
                    tipo_inmueble: "",
                    metro_cuadrado: "",
                    porcentaje_inm: "",
                    estado_inm: "Activo",
                    edificios_idedificio: null,
                    propietarios_idpropietario: null
                },
                edificios: [],
                propietarios: [],
                idEdificioSeleccionado: ""
            },
            methods: {
                listarEdificios() {
                    this.$http.get('/api/edificio')
                        .then(res => this.edificios = res.body)
                        .catch(err => console.error('Error al cargar edificios:', err));
                },
                obtenerPropietarios(idEdificio) {
                    this.$http.get(`/api/propietarios/edificio/${idEdificio}`)
                        .then(res => {
                            this.propietarios = res.body;
                        })
                        .catch(err => {
                            console.error('Error al cargar propietarios', err);
                            this.propietarios = [];
                        });
                },

                guardarInmueble() {
                    // Validar selección
                    if (!this.idEdificioSeleccionado) {
                        alert('Seleccione un edificio');
                        return;
                    }
                    if (!this.inmueble.propietarios_idpropietario) {
                        alert('Seleccione un propietario');
                        return;
                    }

                    this.inmueble.edificios_idedificio = this.idEdificioSeleccionado;

                    this.$http.post('/api/inmuebles/crear', this.inmueble)
                        .then(() => {
                            alert('Inmueble registrado correctamente');
                            window.location.href = '/estate';
                        })
                        .catch(err => {
                            console.error('Error al crear inmueble:', err);
                            alert('No se pudo registrar el inmueble');
                        });
                }
            },
            watch: {
                idEdificioSeleccionado(newVal) {
                    if (newVal) this.listarPropietariosPorEdificio(newVal);
                    else this.propietarios = [];
                }
            },
            mounted() {
                this.listarEdificios();
            }
        });
    </script>
</body>

</html>